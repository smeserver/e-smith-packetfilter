diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Logging mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Logging
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Logging	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Logging	2006-08-13 07:26:34.000000000 -0400
@@ -0,0 +1 @@
+most
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/status mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/status
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/status	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/status	2006-08-13 07:26:34.000000000 -0400
@@ -0,0 +1 @@
+enabled
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Trace mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Trace
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Trace	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/db/configuration/defaults/masq/Trace	2006-08-13 07:26:34.000000000 -0400
@@ -0,0 +1 @@
+disabled
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/00start mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/00start
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/00start	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/00start	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,5 @@
+
+case "$1" in
+
+ start)
+    echo -n "Enabling IP masquerading: "
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/10flush mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/10flush
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/10flush	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/10flush	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,3 @@
+    /sbin/iptables --flush  FORWARD
+    /sbin/iptables --flush  INPUT
+    /sbin/iptables --flush  OUTPUT
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/86startdone mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/86startdone
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/86startdone	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/86startdone	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,4 @@
+    $0 adjust
+    echo "done"
+    ;;
+
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98restart mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98restart
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98restart	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98restart	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,6 @@
+restart)
+        $0 stop
+        $0 start
+        ;;
+
+
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98stop mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98stop
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98stop	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98stop	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,38 @@
+{
+#####STOP FIREWALL####
+}
+stop)
+     echo ""
+     echo -n "Shutting down IP masquerade and firewall rules:"
+     /sbin/iptables -P FORWARD DROP
+     /sbin/iptables -P OUTPUT ACCEPT
+     /sbin/iptables -P INPUT {
+     # Set "safe" default mode.
+     ($SystemMode eq "serveronly") ? "ACCEPT" : "DROP"
+}
+     /sbin/iptables -F INPUT
+     /sbin/iptables -F OUTPUT
+     /sbin/iptables -F FORWARD
+     /sbin/iptables -F 
+{
+    $OUT .= '';
+    # Allow forwarding of local addresses, as we might be a VPN endpoint
+    # in serveronly mode
+    # @locals contains a list of local networks, with the real local
+    # network first
+    my @mylocals = @locals;
+    my $local = shift @mylocals;
+    $OUT .= "    /sbin/iptables --append FORWARD -s $local" .
+			" -d $local -j ACCEPT\n";
+    foreach my $network (@mylocals)
+    {
+	$OUT .= "    /sbin/iptables --append FORWARD -s $network" .
+			" -d $local -j ACCEPT\n";
+	$OUT .= "    /sbin/iptables --append FORWARD -s $local" .
+			" -d $network -j ACCEPT\n";
+    }
+}     /sbin/iptables -X 
+     echo "		Done!"
+     echo "" ;;
+
+
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98trace mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98trace
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98trace	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98trace	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,15 @@
+trace)
+    trace=$(/sbin/e-smith/config getprop masq Trace)
+    if [ $trace = "enabled" ]; then
+        action="stop"
+        echo "Disabling iptables-trace..."
+        /sbin/e-smith/config setprop masq Trace disabled
+    else
+        action="start"
+        echo "Enabling iptables-trace..."
+        /sbin/e-smith/config setprop masq Trace enabled
+    fi
+
+    /etc/init.d/iptables-trace $action
+    ;;
+
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98usage mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98usage
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98usage	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates/etc/rc.d/init.d/masq/98usage	2006-08-13 07:25:56.000000000 -0400
@@ -0,0 +1,6 @@
+ *)
+    echo "Usage: masq \{start|stop|restart|...\}"
+    exit 1
+
+esac
+exit 0
diff -Nur -x '*.orig' -x '*.rej' e-smith-packetfilter-1.17.0/root/etc/e-smith/templates.metadata/etc/rc.d/init.d/masq mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates.metadata/etc/rc.d/init.d/masq
--- e-smith-packetfilter-1.17.0/root/etc/e-smith/templates.metadata/etc/rc.d/init.d/masq	1969-12-31 19:00:00.000000000 -0500
+++ mezzanine_patched_e-smith-packetfilter-1.17.0/root/etc/e-smith/templates.metadata/etc/rc.d/init.d/masq	2006-08-13 07:27:08.000000000 -0400
@@ -0,0 +1 @@
+PERMS=0755
